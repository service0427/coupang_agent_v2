/**
 * í†µí•© ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê´€ë¦¬ì V3
 * - í‚¤ì›Œë“œ ID ì •ë³´ê°€ ëª¨ë“  ë¡œê·¸ì— í‘œì‹œ
 * - CLI í”Œë˜ê·¸ ê¸°ë°˜ ëª¨ë“œ ì „í™˜ 
 * - ìµœì í™” ì»¨í…ìŠ¤íŠ¸ í†µí•©
 * - ìºì‹œ í†µê³„ ì •í™•ì„± ë³´ì¥
 * - ë©€í‹°ëª¨ë“œ ê°œë³„ í‚¤ì›Œë“œ êµ¬ë¶„
 */

const NetworkMonitor = require('../network/monitor');
const NetworkAnalyzer = require('../network/analyzer');

class IntegratedTrafficManager {
  constructor(options = {}) {
    // í•„ìˆ˜ ì‹ë³„ ì •ë³´
    this.keywordId = options.keywordId || null;
    this.agent = options.agent || null;
    this.keyword = options.keyword || '';
    
    // ëª¨ë“œ ì„¤ì •
    this.verboseMode = options.verbose || options.trafficDetail || false;
    this.saveReports = options.saveReports || false;
    
    // ìµœì í™” ì»¨í…ìŠ¤íŠ¸
    this.optimizationContext = options.optimizationContext || null;
    
    // ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸
    this.monitor = new NetworkMonitor();
    this.analyzer = new NetworkAnalyzer();
    this.isActive = false;
    
    // ë¡œê·¸ ì‹ë³„ì
    this.logPrefix = this._createLogPrefix();
  }
  
  /**
   * ë¡œê·¸ ì‹ë³„ì ìƒì„±
   */
  _createLogPrefix() {
    if (this.agent && this.keywordId) {
      return `[${this.agent}:${this.keywordId}]`;
    } else if (this.keywordId) {
      return `[ID:${this.keywordId}]`;
    } else if (this.agent) {
      return `[${this.agent}]`;
    }
    return '[Traffic]';
  }
  
  /**
   * í‚¤ì›Œë“œ ID í¬í•¨ ë¡œê·¸ ì¶œë ¥
   */
  logWithId(message, level = 'info') {
    console.log(`${this.logPrefix} ${message}`);
  }
  
  /**
   * íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì‹œì‘
   */
  async start(page) {
    if (this.isActive) {
      this.logWithId('âš ï¸ ì´ë¯¸ ëª¨ë‹ˆí„°ë§ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    this.isActive = true;
    await this.monitor.start(page);
    
    if (this.verboseMode) {
      this.logWithId('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ìƒì„¸ ëª¨ë“œ)');
    } else {
      this.logWithId('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ê°„ë‹¨ ëª¨ë“œ)');
    }
  }
  
  /**
   * íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ë° ë¶„ì„
   */
  async stop() {
    if (!this.isActive) {
      this.logWithId('âš ï¸ ëª¨ë‹ˆí„°ë§ì´ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return null;
    }
    
    this.isActive = false;
    this.logWithId('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€');
    await this.monitor.stop();
    
    // ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„
    const networkData = this.monitor.getData();
    const analysisResult = this.analyzer.analyze(networkData, this.optimizationContext);
    
    // ë°ì´í„° ê²€ì¦
    this._validateData(networkData, analysisResult);
    
    // ê²°ê³¼ ì¶œë ¥
    this._outputResults(analysisResult);
    
    // ë¦¬í¬íŠ¸ ì €ì¥
    if (this.saveReports && this.keywordId && this.agent) {
      await this._saveReports(analysisResult);
    }
    
    return analysisResult;
  }
  
  /**
   * ë°ì´í„° ì¼ê´€ì„± ê²€ì¦
   */
  _validateData(networkData, analysisResult) {
    const monitorCached = networkData.cacheStats?.fromCache || 0;
    const analyzerCached = analysisResult.requests?.filter(req => req.fromCache).length || 0;
    
    if (Math.abs(monitorCached - analyzerCached) > 0) {
      this.logWithId(`âš ï¸ ìºì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜: Monitor=${monitorCached}, Analyzer=${analyzerCached}`);
    }
    
    if (this.verboseMode) {
      this.logWithId(`ğŸ” ë°ì´í„° ê²€ì¦: ìš”ì²­=${networkData.totalRequests}ê°œ, ìºì‹œ=${monitorCached}ê°œ`);
    }
  }
  
  /**
   * ê²°ê³¼ ì¶œë ¥ (ëª¨ë“œë³„)
   */
  _outputResults(analysisResult) {
    if (this.verboseMode) {
      this._printDetailedAnalysis(analysisResult);
    } else {
      this._printSimpleSummary(analysisResult);
    }
  }
  
  /**
   * ê°„ë‹¨ ìš”ì•½ ì¶œë ¥
   */
  _printSimpleSummary(analysisResult) {
    const { summary, cacheStats, recommendations } = analysisResult;
    
    this.logWithId(`ğŸ“Š íŠ¸ë˜í”½ ìš”ì•½: ${summary.totalRequests}ê°œ ìš”ì²­, ${summary.totalSizeInMB}MB`);
    
    // ìºì‹œ íš¨ìœ¨ì„±
    if (cacheStats && cacheStats.fromCache > 0) {
      const cachedRequests = analysisResult.requests.filter(req => req.fromCache);
      const cachedSize = cachedRequests.reduce((sum, req) => sum + (req.size || 0), 0);
      const cacheSavingsMB = (cachedSize / 1024 / 1024).toFixed(2);
      
      this.logWithId(`ğŸ’¾ ìºì‹œ ì ˆê°: ${cacheStats.fromCache}ê°œ (${cacheStats.cacheHitRate}%) â†’ ${cacheSavingsMB}MB ì ˆì•½`);
    } else {
      this.logWithId(`ğŸ’¾ ìºì‹œ ì‚¬ìš©ë¥ : 0% (ìºì‹œ í™œìš© ì—†ìŒ)`);
    }
    
    // ì£¼ìš” ê¶Œì¥ì‚¬í•­
    const highPriorityRecs = recommendations.filter(rec => rec.priority === 'HIGH');
    if (highPriorityRecs.length > 0) {
      this.logWithId(`ğŸ’¡ ìµœì í™” ê¸°íšŒ: ${highPriorityRecs.length}ê°œ`);
      highPriorityRecs.slice(0, 2).forEach(rec => {
        if (rec.savingPotential) {
          this.logWithId(`   - ${rec.type}: ${rec.savingPotential} ì ˆì•½ ê°€ëŠ¥`);
        }
      });
    }
    
    // íš¨ìœ¨ì„± ì ìˆ˜
    const efficiencyScore = this._calculateEfficiencyScore(analysisResult);
    this.logWithId(`âš¡ íš¨ìœ¨ì„± ì ìˆ˜: ${efficiencyScore}/100`);
  }
  
  /**
   * ìƒì„¸ ë¶„ì„ ì¶œë ¥
   */
  _printDetailedAnalysis(analysisResult) {
    const { summary, domains, resourceTypes, protocols, largeResources, recommendations, cacheStats } = analysisResult;
    
    console.log('\n' + '='.repeat(80));
    console.log(`${this.logPrefix} ğŸ“Š ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ë¶„ì„ ê²°ê³¼ (ìƒì„¸)`);
    console.log('='.repeat(80));
    
    // ìš”ì•½ ì •ë³´
    console.log('\nğŸ“ˆ ìš”ì•½:');
    console.log(`   ì´ ìš”ì²­ ìˆ˜: ${summary.totalRequests}ê°œ`);
    console.log(`   ì´ ë°ì´í„° í¬ê¸°: ${summary.totalSizeInMB} MB`);
    console.log(`   í‰ê·  ìš”ì²­ í¬ê¸°: ${(summary.avgRequestSize / 1024).toFixed(2)} KB`);
    console.log(`   ì´ˆë‹¹ ìš”ì²­ ìˆ˜: ${summary.requestsPerSecond}`);
    console.log(`   ë¶„ì„ ì‹œê°„: ${summary.duration}ì´ˆ`);
    
    // ìƒìœ„ ë„ë©”ì¸
    console.log('\nğŸŒ ìƒìœ„ ë„ë©”ì¸ (ë°ì´í„° ì‚¬ìš©ëŸ‰ ê¸°ì¤€):');
    domains.slice(0, 10).forEach((domain, index) => {
      console.log(`   ${index + 1}. ${domain.domain}`);
      console.log(`      ìš”ì²­: ${domain.count}ê°œ, í¬ê¸°: ${(domain.size / 1024 / 1024).toFixed(2)} MB (${domain.percentage}%)`);
      
      const topTypes = domain.types.sort((a, b) => b.size - a.size).slice(0, 3);
      topTypes.forEach(type => {
        console.log(`        - ${type.type}: ${type.count}ê°œ, ${(type.size / 1024 / 1024).toFixed(2)} MB`);
      });
    });
    
    // ë¦¬ì†ŒìŠ¤ íƒ€ì…ë³„ ë¶„í¬
    console.log('\nğŸ“ ë¦¬ì†ŒìŠ¤ íƒ€ì…ë³„ ë¶„í¬:');
    resourceTypes.forEach(type => {
      const sizeInMB = (type.size / 1024 / 1024).toFixed(2);
      console.log(`   ${type.type}: ${type.count}ê°œ, ${sizeInMB} MB (${type.percentage}%)`);
    });
    
    // í”„ë¡œí† ì½œ ì‚¬ìš© í˜„í™©
    console.log('\nğŸ” í”„ë¡œí† ì½œ ì‚¬ìš© í˜„í™©:');
    protocols.forEach(proto => {
      console.log(`   ${proto.protocol}: ${proto.count}ê°œ (${proto.percentage}%)`);
    });
    
    // ìºì‹œ í†µê³„
    if (cacheStats) {
      console.log('\nğŸ’¾ ìºì‹œ ì‚¬ìš© í˜„í™©:');
      console.log(`   ì „ì²´ ìš”ì²­: ${cacheStats.total}ê°œ`);
      console.log(`   ìºì‹œ íˆíŠ¸: ${cacheStats.fromCache}ê°œ (${cacheStats.cacheHitRate}%)`);
      console.log(`   ë„¤íŠ¸ì›Œí¬: ${cacheStats.fromNetwork}ê°œ`);
      
      if (cacheStats.fromCache > 0) {
        const cachedRequests = analysisResult.requests.filter(req => req.fromCache);
        const cachedSize = cachedRequests.reduce((sum, req) => sum + (req.size || 0), 0);
        console.log(`   ìºì‹œëœ ë°ì´í„°: ${(cachedSize / 1024 / 1024).toFixed(2)} MB`);
        
        if (cacheStats.byType && cacheStats.byType.length > 0) {
          console.log('\n   ë¦¬ì†ŒìŠ¤ íƒ€ì…ë³„ ìºì‹œ íˆíŠ¸ìœ¨:');
          cacheStats.byType
            .sort((a, b) => b.total - a.total)
            .forEach(type => {
              console.log(`   - ${type.type}: ${type.cached}/${type.total} (${type.hitRate}%)`);
            });
        }
      }
    }
    
    // ëŒ€ìš©ëŸ‰ ë¦¬ì†ŒìŠ¤
    if (largeResources.length > 0) {
      console.log('\nâš ï¸  ëŒ€ìš©ëŸ‰ ë¦¬ì†ŒìŠ¤ (1MB ì´ìƒ):');
      largeResources.slice(0, 3).forEach((resource, index) => {
        console.log(`   ${index + 1}. ${resource.domain} - ${resource.type}`);
        console.log(`      í¬ê¸°: ${resource.sizeInMB} MB`);
      });
    }
    
    // ê¶Œì¥ì‚¬í•­
    if (recommendations.length > 0) {
      console.log('\nğŸ’¡ íŠ¸ë˜í”½ ê°ì†Œ ê¶Œì¥ì‚¬í•­:');
      recommendations.forEach((rec, index) => {
        console.log(`\n   ${index + 1}. [${rec.priority}] ${rec.type}`);
        console.log(`      ${rec.message}`);
        if (rec.savingPotential) {
          console.log(`      ì˜ˆìƒ ì ˆê°ëŸ‰: ${rec.savingPotential}`);
        }
      });
    }
    
    console.log('\n' + '='.repeat(80));
  }
  
  /**
   * íš¨ìœ¨ì„± ì ìˆ˜ ê³„ì‚° (0-100)
   */
  _calculateEfficiencyScore(analysisResult) {
    const { summary, cacheStats, recommendations } = analysisResult;
    let score = 70; // ê¸°ë³¸ ì ìˆ˜
    
    // ìºì‹œ íš¨ìœ¨ì„± ì ìˆ˜ (30ì )
    if (cacheStats) {
      const cacheHitRate = parseFloat(cacheStats.cacheHitRate || 0);
      score += Math.min(30, cacheHitRate * 0.3);
    }
    
    // íŠ¸ë˜í”½ í¬ê¸° ì ìˆ˜
    const sizeInMB = parseFloat(summary.totalSizeInMB);
    if (sizeInMB <= 0.5) score += 20;      // 0.5MB ì´í•˜: ë§Œì 
    else if (sizeInMB <= 1.0) score += 15; // 1MB ì´í•˜: ìš°ìˆ˜
    else if (sizeInMB <= 2.0) score += 10; // 2MB ì´í•˜: ì–‘í˜¸
    else if (sizeInMB <= 5.0) score += 5;  // 5MB ì´í•˜: ë³´í†µ
    else score -= 10; // 5MB ì´ˆê³¼: ê°ì 
    
    // ê¶Œì¥ì‚¬í•­ í˜ë„í‹°
    const highPriorityIssues = recommendations.filter(rec => rec.priority === 'HIGH').length;
    score -= highPriorityIssues * 5;
    
    return Math.max(0, Math.min(100, Math.round(score)));
  }
  
  /**
   * ë¦¬í¬íŠ¸ ì €ì¥
   */
  async _saveReports(analysisResult) {
    try {
      this.logWithId('ğŸ“„ íŠ¸ë˜í”½ ë¦¬í¬íŠ¸ ì €ì¥ ì¤‘...');
      
      await this.analyzer.saveReport(this.keywordId, this.agent);
      
      if (analysisResult.cacheStats && analysisResult.cacheStats.fromCache > 0) {
        await this.analyzer.saveCacheReport(this.keywordId, this.agent);
      }
      
      this.logWithId('ğŸ“„ íŠ¸ë˜í”½ ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ');
    } catch (error) {
      this.logWithId(`âš ï¸ ë¦¬í¬íŠ¸ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
    }
  }
  
  /**
   * ëŸ°íƒ€ì„ ëª¨ë“œ ì „í™˜
   */
  setVerboseMode(enabled) {
    this.verboseMode = enabled;
    this.logWithId(`ğŸ”§ ëª¨ë“œ ë³€ê²½: ${enabled ? 'ìƒì„¸' : 'ê°„ë‹¨'} ëª¨ë“œ`);
  }
  
  /**
   * í˜„ì¬ ìºì‹œ í†µê³„ ì¡°íšŒ
   */
  getCurrentCacheStats() {
    if (!this.isActive) {
      return { message: 'ëª¨ë‹ˆí„°ë§ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
    }
    
    const data = this.monitor.getData();
    const { cacheStats } = data;
    
    if (!cacheStats || cacheStats.total === 0) {
      return { message: 'ì•„ì§ ìºì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }
    
    const cachedRequests = data.requests.filter(req => req.fromCache);
    const cacheSavingsMB = cachedRequests.reduce((sum, req) => sum + (req.size || 0), 0) / 1024 / 1024;
    
    return {
      total: cacheStats.total,
      cached: cacheStats.fromCache,
      hitRate: cacheStats.cacheHitRate,
      savingsMB: cacheSavingsMB.toFixed(2),
      memoryCache: cacheStats.fromMemoryCache,
      diskCache: cacheStats.fromDiskCache
    };
  }
  
  /**
   * ë¦¬ì†ŒìŠ¤ ì •ë¦¬
   */
  async cleanup() {
    if (this.isActive) {
      this.logWithId('ğŸ§¹ íŠ¸ë˜í”½ ë§¤ë‹ˆì € ì •ë¦¬ ì¤‘...');
      await this.stop();
    }
    this.monitor.reset();
    this.logWithId('âœ… íŠ¸ë˜í”½ ë§¤ë‹ˆì € ì •ë¦¬ ì™„ë£Œ');
  }
}

module.exports = IntegratedTrafficManager;