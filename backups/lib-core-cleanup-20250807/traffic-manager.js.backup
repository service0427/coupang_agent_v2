/**
 * í†µí•© ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê´€ë¦¬ì
 * - NetworkMonitorì™€ NetworkAnalyzer í†µí•©
 * - CLI ì˜µì…˜ì— ë”°ë¥¸ ë¡œê·¸ ë ˆë²¨ ì œì–´
 * - USB ë™ê¸€ í™˜ê²½ì— ìµœì í™”ëœ ê°„ë‹¨/ìƒì„¸ ì¶œë ¥
 */

const NetworkMonitor = require('../network/monitor');
const NetworkAnalyzer = require('../network/analyzer');

class NetworkTrafficManager {
  constructor(options = {}) {
    this.verboseMode = options.verbose || false;
    this.saveReports = options.saveReports || false;
    this.monitor = new NetworkMonitor();
    this.analyzer = new NetworkAnalyzer();
    this.isActive = false;
  }

  /**
   * íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì‹œì‘
   */
  async start(page) {
    if (this.isActive) return;
    
    this.isActive = true;
    await this.monitor.start(page);
    
    if (!this.verboseMode) {
      console.log('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ê°„ë‹¨ ëª¨ë“œ)');
    }
  }

  /**
   * íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ë° ë¶„ì„
   */
  async stop(keywordId = null, agent = null, optimizationContext = null) {
    if (!this.isActive) return null;
    
    this.isActive = false;
    await this.monitor.stop();
    
    const networkData = this.monitor.getData();
    const analysisResult = this.analyzer.analyze(networkData, optimizationContext);
    
    // ë””ë²„ê·¸: ID ì •ë³´ í™•ì¸
    console.log(`ğŸ” TrafficManager.stop - keywordId: ${keywordId}, agent: ${agent}, verboseMode: ${this.verboseMode}`);
    
    // ì¶œë ¥ ëª¨ë“œì— ë”°ë¥¸ ë¡œê·¸
    if (this.verboseMode) {
      this.analyzer.printAnalysis(keywordId, agent);
    } else {
      this.printSimpleSummary(analysisResult, keywordId, agent);
    }
    
    // ë¦¬í¬íŠ¸ ì €ì¥ (ìš”ì²­ì‹œì—ë§Œ)
    if (this.saveReports && keywordId && agent) {
      await this.analyzer.saveReport(keywordId, agent);
      if (analysisResult.cacheStats && analysisResult.cacheStats.fromCache > 0) {
        await this.analyzer.saveCacheReport(keywordId, agent);
      }
    }
    
    return analysisResult;
  }

  /**
   * ê°„ë‹¨ ìš”ì•½ ì¶œë ¥ (ê¸°ë³¸ ëª¨ë“œ)
   */
  printSimpleSummary(analysisResult, keywordId = null, agent = null) {
    const { summary, cacheStats, recommendations } = analysisResult;
    
    const idInfo = keywordId ? `[ID:${keywordId}] ` : '';
    console.log(`\nğŸ“Š ${idInfo}íŠ¸ë˜í”½ ìš”ì•½: ${summary.totalRequests}ê°œ ìš”ì²­, ${summary.totalSizeInMB}MB`);
    
    // ìºì‹œ íš¨ìœ¨ì„±
    if (cacheStats && cacheStats.fromCache > 0) {
      const cachedRequests = analysisResult.requests.filter(req => req.fromCache);
      const cachedSize = cachedRequests.reduce((sum, req) => sum + (req.size || 0), 0);
      const cacheSavingsMB = (cachedSize / 1024 / 1024).toFixed(2);
      
      console.log(`ğŸ’¾ ìºì‹œ ì ˆê°: ${cacheStats.fromCache}ê°œ (${cacheStats.cacheHitRate}%) â†’ ${cacheSavingsMB}MB ì ˆì•½`);
    }
    
    // ì£¼ìš” ê¶Œì¥ì‚¬í•­ë§Œ í‘œì‹œ
    const highPriorityRecs = recommendations.filter(rec => rec.priority === 'HIGH');
    if (highPriorityRecs.length > 0) {
      console.log(`ğŸ’¡ ìµœì í™” ê¸°íšŒ: ${highPriorityRecs.length}ê°œ`);
      highPriorityRecs.slice(0, 2).forEach(rec => {
        if (rec.savingPotential) {
          console.log(`   - ${rec.type}: ${rec.savingPotential} ì ˆì•½ ê°€ëŠ¥`);
        }
      });
    }
    
    // ì „ì²´ íš¨ìœ¨ì„± ì ìˆ˜
    const efficiencyScore = this.calculateEfficiencyScore(analysisResult);
    console.log(`âš¡ íš¨ìœ¨ì„± ì ìˆ˜: ${efficiencyScore}/100`);
  }

  /**
   * íš¨ìœ¨ì„± ì ìˆ˜ ê³„ì‚° (0-100)
   */
  calculateEfficiencyScore(analysisResult) {
    const { summary, cacheStats, recommendations } = analysisResult;
    let score = 70; // ê¸°ë³¸ ì ìˆ˜
    
    // ìºì‹œ íš¨ìœ¨ì„± ì ìˆ˜ (30ì )
    if (cacheStats) {
      const cacheHitRate = parseFloat(cacheStats.cacheHitRate || 0);
      score += Math.min(30, cacheHitRate * 0.3);
    }
    
    // íŠ¸ë˜í”½ í¬ê¸° ì ìˆ˜ (ìŒìˆ˜ ê°€ëŠ¥)
    const sizeInMB = parseFloat(summary.totalSizeInMB);
    if (sizeInMB <= 0.5) score += 20;      // 0.5MB ì´í•˜: ë§Œì 
    else if (sizeInMB <= 1.0) score += 15; // 1MB ì´í•˜: ìš°ìˆ˜
    else if (sizeInMB <= 2.0) score += 10; // 2MB ì´í•˜: ì–‘í˜¸
    else if (sizeInMB <= 5.0) score += 5;  // 5MB ì´í•˜: ë³´í†µ
    else score -= 10; // 5MB ì´ˆê³¼: ê°ì 
    
    // ê¶Œì¥ì‚¬í•­ í˜ë„í‹°
    const highPriorityIssues = recommendations.filter(rec => rec.priority === 'HIGH').length;
    score -= highPriorityIssues * 5;
    
    return Math.max(0, Math.min(100, Math.round(score)));
  }

  /**
   * ìƒì„¸ ë¶„ì„ ì¶œë ¥ ê°•ì œ ì‹¤í–‰
   */
  printDetailedAnalysis() {
    if (this.analyzer.analysisResults) {
      this.analyzer.printAnalysis();
    } else {
      console.log('âš ï¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
    }
  }

  /**
   * ìºì‹œ íš¨ìœ¨ì„± ì‹¤ì‹œê°„ í™•ì¸
   */
  getCurrentCacheStats() {
    const data = this.monitor.getData();
    const { cacheStats } = data;
    
    if (cacheStats.total === 0) {
      return { message: 'ì•„ì§ ìºì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' };
    }
    
    const cachedRequests = data.requests.filter(req => req.fromCache);
    const cacheSavingsMB = cachedRequests.reduce((sum, req) => sum + (req.size || 0), 0) / 1024 / 1024;
    
    return {
      total: cacheStats.total,
      cached: cacheStats.fromCache,
      hitRate: cacheStats.cacheHitRate,
      savingsMB: cacheSavingsMB.toFixed(2),
      memoryCache: cacheStats.fromMemoryCache,
      diskCache: cacheStats.fromDiskCache
    };
  }

  /**
   * ë¦¬ì†ŒìŠ¤ ì •ë¦¬
   */
  async cleanup() {
    if (this.isActive) {
      await this.stop();
    }
    this.monitor.reset();
  }
}

module.exports = NetworkTrafficManager;